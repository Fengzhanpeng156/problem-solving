# u-boot编译

解压源码

```BASH
tar -vxjf uboot-imx-2016.03-2.1.0-g8b546e4.tar.bz2
```

```shell
feng@os:~/linux/alientek_review$ ls
api         fs               System.map
arch        include          test
board       Kbuild           tools
build.sh    Kconfig          u-boot
cmd         lib              u-boot.bin
common      Licenses         u-boot.cfg
compile.sh  MAINTAINERS      u-boot.imx
config.mk   MAKEALL          uboot-imx-2016.03-2.1.0-g0ae7e33-v1.7.tar.bz2
configs     Makefile         u-boot.lds
disk        net              u-boot.map
doc         post             u-boot-nodtb.bin
drivers     README           u-boot.srec
dts         scripts          u-boot.sym
examples    snapshot.commit

```

编写编译脚本

```shell
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- distclean
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- mx6ull_14x14_ddr512_emmc_defconfig
make V=1 ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j8
```

最后输出信息

```SHELL
Image Type:   Freescale IMX Boot Image
Image Ver:    2 (i.MX53/6/7 compatible)
Mode:         DCD
Data Size:    364544 Bytes = 356.00 kB = 0.35 MB
Load Address: 877ff420
Entry Point:  87800000
```

其中，uboot.bin是裸机二进制文件，u-boot.imx是加了头部信息的烧写文件

```bash
feng@os:~/linux/alientek_review$ ./imxdownload u-boot.bin /dev/sdb
I.MX6ULL bin download software
Edit by:zuozhongkai
Date:2019/6/10
Version:V1.1
log:V1.0 initial version,just support 512MB DDR3
    V1.1 and support 256MB DDR3
file u-boot.bin size = 358732Bytes
Board DDR SIZE: 512MB
Delete Old load.imx
Create New load.imx
Download load.imx to /dev/sdb  ......
[sudo] feng 的密码： 
记录了706+1 的读入
记录了706+1 的写出
361804字节（362 kB，353 KiB）已复制，0.778652 s，465 kB/s
```

配置NFS与TFTP

启动

```SHELL
tftp 80800000 zImage 
tftp 83000000 imx6ull-14x14-emmc-7-1024x600-c.dtb 
bootz 80800000 - 83000000
```

# NXP U-boot

## 1 编译

配置完defconfig后

```BASH
feng@os:~/linux/alientek_review/nxp-uboot/uboot-imx-rel_imx_4.1.15_2.1.0_ga$ make ARM=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16
  CHK     include/config/uboot.release
  CHK     include/generated/timestamp_autogenerated.h
  UPD     include/generated/timestamp_autogenerated.h
  CHK     include/generated/version_autogenerated.h
  CHK     include/generated/generic-asm-offsets.h
  CHK     include/generated/asm-offsets.h
  HOSTCC  tools/mkenvimage.o
  HOSTCC  tools/image-host.o
  HOSTCC  tools/dumpimage.o
  HOSTCC  tools/mkimage.o
  HOSTLD  tools/mkenvimage
  HOSTLD  tools/dumpimage
  HOSTLD  tools/mkimage
  CC      drivers/video/cfb_console.o
  CC      common/main.o
  CC      common/board_f.o
  CC      cmd/version.o
  LD      cmd/built-in.o
  CC      lib/display_options.o
  LD      common/built-in.o
  LD      lib/built-in.o
  LD      drivers/video/built-in.o
  LD      drivers/built-in.o
  LD      u-boot
  OBJCOPY u-boot-nodtb.bin
  OBJCOPY u-boot.srec
  SYM     u-boot.sym
  COPY    u-boot.bin
  MKIMAGE u-boot.imx
```

**顶层Makefile可以给ARCH和CROSS_COMPILE写死，这块在后面设备树那里很重要**

**要不然无法用内核编译**

## 2 烧写

mmc dev 0检查sd卡 mmc info

mmc dev 1检查emmc， mmc info

## 3 在uboot中添加自己的开发板

先在 configs目录下创建默认配置文件，复制 mx6ull_14x14_evk_emmc_defconfig，

然后重命名为 mx6ull_alientek_emmc_defconfig，命令如下

```BASH
feng@os:~/linux/alientek_review/nxp-uboot/uboot-imx-rel_imx_4.1.15_2.1.0_ga/configs$ cp mx6ull_14x14_evk_emmc_defconfig mx6ull_alientek_emmc_defconfig
```

**修改默认配置文件**

```
CONFIG_SYS_EXTRA_OPTIONS="IMX_CONFIG=board/freescale/mx6ull_alientek_emmc/imximage.cfg,MX6ULL_EVK_EMMC_REWORK"
CONFIG_ARM=y
CONFIG_ARCH_MX6=y
CONFIG_TARGET_MX6ULL_ALIENTEK_EMMC=y
CONFIG_CMD_GPIO=y

```

修改了1和4行

**添加开发板头文件信息**

在目录 include/configs下添加 I.MX6ULL-ALPHA开发板对应的头文件，复制
include/configs/mx6ullevk.h

```C
#ifndef __MX6ULL_ALIENTEK_EMMC_CONFIG_H
#define __MX6ULL_ALIENTEK_EMMC_CONFIG_H
```

**添加板级文件**

```
/board/freescale$ cp mx6ullevk/ -r mx6ull_alientek_emmc
```

目录中，将其中的 mx6ullevk.c文件重命名为mx6ull_alientek_emmc.c

- 修改目录下Makefile,改目标文件名

```makefile
# (C) Copyright 2015 Freescale Semiconductor, Inc.
#
# SPDX-License-Identifier:	GPL-2.0+
#

obj-y  := mx6ull_alientek_emmc.o

extra-$(CONFIG_USE_PLUGIN) :=  plugin.bin
$(obj)/plugin.bin: $(obj)/plugin.o
	$(OBJCOPY) -O binary --gap-fill 0xff $< $@
```

- 修改 mx6ull_alientek_emmc目录下的 imximage.cfg文件

32行 **/plugin.bin 0x00907000前有空格**

```C
#ifdef CONFIG_USE_PLUGIN
/*PLUGIN    plugin-binary-file    IRAM_FREE_START_ADDR*/
PLUGIN	board/freescale/mx6ull_alientek_emmc /plugin.bin 0x00907000
#else
```

- 修改 mx6ull_alientek_emmc目录下的 Kconfig文件

```
if TARGET_MX6ULL_ALIENTEK_EMMC

config SYS_BOARD
	default "mx6ull_alientek_emmc"

config SYS_VENDOR
	default "freescale"

config SYS_CONFIG_NAME
	default "mx6ull_alientek_emmc"

endif

```

- 、修改 mx6ull_alientek_emmc目录下的 MAINTAINERS文件

- 修改图形化配置

修改文件arch/arm/cpu/armv7/mx6/Kconfig

添加

```
config TARGET_MX6ULL_ALIENTEK_EMMC
	bool "Support mx6ull_alientek_emmc"
	select MX6ULL
	select DM
	select DM_THERMAL
```

```
source "board/freescale/mx6ull_alientek_emmc/Kconfig"
```

- 修改LCD

一般 uboot中修改驱动基本都是在 xxx.h和 xxx.c这两个文件中进行的， xxx为板子名称，比如 mx6ull_alientek_emmc.h和 mx6ull_alientek_emmc.c这两个文件。

一般修改 LCD驱动重点注意以下几点：
①、 LCD所使用的 GPIO，查看 uboot中 LCD的 IO配置是否正确。
②、 LCD背光引脚 GPIO的配置。
③、 LCD配置参数是否正确。

打开文件 mx6ull_alientek_emmc.c

```C
//780行
struct display_info_t const displays[] = {{
	.bus = MX6UL_LCDIF1_BASE_ADDR,
	.addr = 0,
	.pixfmt = 24,
	.detect = NULL,
	.enable	= do_enable_parallel_lcd,
	.mode	= {
		.name			= "TFT43AB",
		.xres           = 800,
		.yres           = 480,
		.pixclock       = 32258,
		.left_margin    = 88,
		.right_margin   = 40,
		.upper_margin   = 32,
		.lower_margin   = 13,
		.hsync_len      = 48,
		.vsync_len      = 3,
		.sync           = 0,
		.vmode          = FB_VMODE_NONINTERLACED
} } };
```

name ：LCD名字，要和环境变量中的 panel相等

panel的值要与 .name成员变量的值一致。

这是因为之前有将环境变量保存到 EMMC中， uboot启动以后会先从 EMMC中读取环境变量，如果 EMMC中没有环境变量的话才会使用 mx6ull_alientek_emmc.h中的默认环境变量。
如果 EMMC中的环境变量 panel不等于 TFT4384，那么 LCD显示肯定不正常，我们只需要在uboot中修改 panel的值为 TFT4384即可
